rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isNotBanned() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.banned != true;
    }

    function getEventData(eventId) {
      return get(/databases/$(database)/documents/events/$(eventId)).data;
    }

    // Users collection
    match /users/{userId} {
      // Solo usuarios autenticados pueden leer perfiles (no público)
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() &&
                    isOwner(userId) &&
                    request.resource.data.keys().hasAll(['email', 'username', 'role']) &&
                    request.resource.data.role in ['user', 'admin'] &&
                    // Validar que el email coincida con el auth
                    request.resource.data.email == request.auth.token.email;
    }

    // Events collection
    match /events/{eventId} {
      allow read: if true; // Permitir lectura pública para que aparezcan en homepage
      
      allow create: if isAuthenticated() && 
                    isNotBanned() &&
                    request.resource.data.keys().hasAll(['title', 'description', 'category', 'date', 'time', 'address', 'lat', 'lng', 'creatorId']) &&
                    request.resource.data.creatorId == request.auth.uid;

      // Solo el creador puede actualizar el evento completo
      // Cualquier usuario autenticado puede solo incrementar/decrementar attendees
      allow update: if isAuthenticated() &&
                    (
                      // El creador puede actualizar todo
                      (request.auth.uid == resource.data.creatorId &&
                       request.resource.data.creatorId == resource.data.creatorId) ||
                      // Otros usuarios solo pueden actualizar attendees (con límites)
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendees']) &&
                       request.resource.data.attendees is number &&
                       (request.resource.data.attendees == resource.data.attendees + 1 ||
                        request.resource.data.attendees == resource.data.attendees - 1))
                    );

      allow delete: if isAdmin() || 
                    (request.auth != null &&
                     request.auth.uid == resource.data.creatorId);

      // Messages subcollection under events
      match /messages/{messageId} {
        allow read: if isAuthenticated() && isNotBanned();
        allow create: if isAuthenticated() && 
                     isNotBanned() && 
                     isOwner(request.resource.data.userId) &&
                     request.resource.data.keys().hasAll(['text', 'timestamp', 'userId']);
        allow update: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
        allow delete: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      }
    }

    // Chats collection (Enhanced Chat System)
    match /chats/{chatId} {
      allow read: if isNotBanned();
      allow create: if isAuthenticated() && isNotBanned();

      // Messages subcollection con soporte mejorado
      match /messages/{messageId} {
        allow read: if isNotBanned();
        
        allow create: if isAuthenticated() &&
                     isNotBanned() &&
                     isOwner(request.resource.data.userId) &&
                     request.resource.data.keys().hasAll(['type', 'timestamp', 'userId', 'eventId']) &&
                     request.resource.data.type in ['TEXT', 'IMAGE', 'LOCATION', 'EVENT_UPDATE', 'REACTION'] &&
                     // Verificar que el evento exista
                     exists(/databases/$(database)/documents/events/$(request.resource.data.eventId));
        
        // Actualizar: dueño del mensaje o admin (para reacciones, editar, eliminar)
        allow update: if isAuthenticated() &&
                     (
                       // Dueño puede editar su mensaje o agregar reacciones
                       (isOwner(resource.data.userId) &&
                        request.resource.data.userId == resource.data.userId) ||
                       // Admin puede todo
                       isAdmin()
                     );
        
        // Eliminar: solo admin o dueño (soft delete)
        allow delete: if isAuthenticated() &&
                     (isOwner(resource.data.userId) || isAdmin());
      }

      // Participantes subcollection
      match /participants/{userId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow delete: if isAdmin();
      }
    }

    // Reports collection
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated() &&
                    isNotBanned() &&
                    isOwner(request.resource.data.reporterId) &&
                    request.resource.data.keys().hasAll(['targetType', 'targetId', 'reporterId', 'reason', 'status']) &&
                    request.resource.data.targetType in ['USER', 'EVENT', 'MESSAGE'] &&
                    request.resource.data.status in ['pending', 'resolved', 'rejected'];
      allow update: if isAdmin();
    }

    // FCM Tokens collection
    match /fcmTokens/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) &&
                    request.resource.data.keys().hasAll(['token', 'platform']);
    }

    // Attendees collection
    match /attendees/{attendeeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                    isNotBanned() &&
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.eventId != null &&
                    request.resource.data.status in ['confirmed', 'pending', 'cancelled'] &&
                    // Verificar que el evento exista
                    exists(/databases/$(database)/documents/events/$(request.resource.data.eventId));
      allow update: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Admin collection (opcional para configuraciones de admin)
    match /admin/{document} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // User Preferences collection (para sistema de recomendaciones)
    match /userPreferences/{userId} {
      // Solo el dueño puede leer y escribir sus preferencias
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
      allow create: if isAuthenticated() &&
                    isOwner(userId) &&
                    request.resource.data.keys().hasAll(['userId', 'favoriteCategories', 'lastUpdated']);
    }

    // User Event History collection (para sistema de recomendaciones)
    match /userEventHistory/{userId} {
      // Solo el dueño puede leer y escribir su historial
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
      allow create: if isAuthenticated() &&
                    isOwner(userId) &&
                    request.resource.data.keys().hasAll(['userId', 'attendedEvents', 'likedEvents', 'savedEvents']);
    }

    // Event Ratings collection (para sistema de calificaciones)
    match /events/{eventId}/ratings/{ratingId} {
      allow read: if true; // Público para mostrar calificaciones
      allow create: if isAuthenticated() &&
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.keys().hasAll(['eventId', 'userId', 'rating', 'ratings']);
      allow update: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Event Rating Summaries (lectura pública)
    match /eventRatingSummaries/{eventId} {
      allow read: if true;
      allow write: if false; // Solo se actualiza via Cloud Functions
    }

    // User Ratings collection (para reputación de usuarios)
    match /users/{userId}/ratings/{ratingId} {
      allow read: if true; // Público para mostrar reputación
      allow create: if isAuthenticated() &&
                    request.resource.data.raterUserId == request.auth.uid &&
                    request.resource.data.keys().hasAll(['ratedUserId', 'raterUserId', 'rating']);
      allow update: if isAuthenticated() &&
                    (resource.data.raterUserId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    // User Rating Summaries (lectura pública)
    match /userRatingSummaries/{userId} {
      allow read: if true;
      allow write: if false; // Solo se actualiza via Cloud Functions
    }

    // Default deny rule
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
